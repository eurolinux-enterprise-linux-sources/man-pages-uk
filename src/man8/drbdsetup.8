." © 2005-2007 DLOU, GNU FDL
." URL: <http://docs.linux.org.ua/index.php/Man_Contents>
." Supported by <docs@linux.org.ua>
."
." Permission is granted to copy, distribute and/or modify this document
." under the terms of the GNU Free Documentation License, Version 1.2
." or any later version published by the Free Software Foundation;
." with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
." 
." A copy of the license is included  as a file called COPYING in the
." main directory of the man-pages-* source package.
."
." This manpage has been automatically generated by wiki2man.py
." This tool can be found at: <http://wiki2man.sourceforge.net>
." Please send any bug reports, improvements, comments, patches, etc. to
." E-mail: <wiki2man-develop@lists.sourceforge.net>.

.TH "drbdsetup" "8" "v 0.7.* переклад: альфа версія 2007-10-27-16:31" "© 2005-2007 DLOU, GNU FDL" "DRBD - кластер дисків"

." This manpage has been automatically generated by docbook2man from a DocBook document.
." This tool can be found at: <http://shell.ipoline.com/~elmert/comp/docbook2X/>
." Please send any bug reports, improvements, comments, patches, etc.
." to Steve Cheng <steve@ggi-project.org>. 

.SH "ІМ'Я"
.PP

\fBdrbdsetup\fR \- інструмент для встановлення DRBD

.SH "СИНТАКСИС"
.PP

.RS
.nf
 drbdsetup device disk lower_dev meta_data_dev meta_data_index [ \-d size ] [ \-e err_handler ]
 drbdsetup device net local_addr [ :port ] remote_addr [ :port ] protocol [ \-c time  ]  [  \-i time ] [ \-t val ] [ \-S size ] [ \-k count ] [ \-d discon_handler ]
 drbdsetup device syncer [ \-k ] [ \-g group ] [ \-r rate ] [ \-e extents ]
 drbdsetup device disconnect
 drbdsetup device detach
 drbdsetup device down
 drbdsetup device primary [ \-h ] [ \-t ] [ \-d ]
 drbdsetup device secondary
 drbdsetup device on_primary [ \-h ] [ \-t ]
 drbdsetup device invalidate
 drbdsetup device invalidate_remote
 drbdsetup device wait_connect [ \-t wfc_timeout ] [ \-d degr_wfc_timeout ]
 drbdsetup device wait_sync [ \-t wfc_timeout ] [ \-d degr_wfc_timeout ]
 drbdsetup device state
 drbdsetup device cstate
 drbdsetup device resize [ \-d size ]
 drbdsetup device show

.fi
.RE

.SH "ОПИС"
.PP

drbdsetup  використовується для встановлення асоціації між DRBD пристроєм та його низькорівневими блочним пристроєм, для встановлення пар DRBD пристроїв, щоб здійснювати дзеркальне відображення їх низькорівневих блочних пристроїв і для перевірки налаштування працюючого DRBD кластеру.

.SH "ПРИМІТКА"
.PP

drbdsetup є низькорівневий інструмент до DRBD кластеру. Він використовується datadisk, drbdadm та drbd скриптом для зв'язку з драйвером пристрою.

.SH "КОМАНДИ"
.PP

Кожна підкоманда drbdsetup потребує аргументів і має свою власну порцію опцій. Усі значення мають свою розмірність по замовчуванню, яку можна змінити суфіксами K, M or G. Їх розмірність визначається звичним шляхом (тобто: K = 2^10 = 1024)

.SS "DISK"

.PP

Зв'язує \fB\fIпристрій\fB\fR з \fB\fIнизькорівневим пристроєм\fB\fR для збереження на ньому блоків даних. Опція  \fB\-d\fR  (чи  \fB\-\-disk\-size\fR) повинна вживатись тільки тоді коли не бажаєте використовувати максимально можливий розмір зумовлений розміром низькорівневих дисків. Якщо не вживати \fB\-d\fR \fB\fIпристрій\fB\fR буде готовий до використання одразу після під'єднання до свого партнера. (Дивіться команду \fBNET\fR.)

.TP
.B \-d, \-\-disk\-size \fB\fIsize\fB\fR
 Ця опція може змінити метод яким DRBD визначає розмір. Якщо ви бажаєте використовувати пристрій перед першим з'єднанням з партнером використайте цю опцію для вказання розміру DRBD пристрою. По замовчуванню в KB (1 KB = 1024 bytes).

.TP
.B \-e, \-\-on\-io\-error \fB\fIerr_handler\fB\fR
 Якщо \fB\fIнизькорівневий пристрій\fB\fR повідомляє помилку до DRBD, DRBD може послати помилку до верхнього рівня операційної системи, створити паніку ядра, чи від'єднати пристрій і проводити всі наступні операції запису/зчитування використовуючи партнера. Допустимі значення \fB\fIerr_handler\fB\fR: \fBpass_on\fR, \fBpanic\fR і \fBdetach\fR.

.SS "NET"

.PP

Встановлює пристрій для прослуховування \fB\fIlocal_addr:port\fB\fR очікуючи з'єднання і для намагання встановити зв'язок з \fB\fIremote_addr:port\fB\fR. Якщо \fB\fIпорт\fB\fR пропущений по замовчуванню використовується 7788.
.br

Поверх TCP/IP з'єднання використовуються спеціальні протоколи. Допустимими протоколами є: А, В та С.
.br

Протокол А: операція запису вважається завершеною, якщо дані досягли локального диску та локальної вихідної черги tcp.
.br

Протокол В: операція запису вважається завершеною, якщо дані досягли локального диску та віддаленої вхідної черги.
.br

Протокол С: операція запису вважається завершеною, якщо дані досягли локального та віддаленого диску.

.TP
.B \-c, \-\-connect\-int \fB\fItime\fB\fR
 У випадку неможливості зв'язку з віддаленим DRBD пристроєм негайно, DRBD буде продовжувати спроби зв'язатись. З допомогою цього параметру можна вказати час між двома спробами. По замовчуванню значення є 10 секунд, крок 1 секунда.

.TP
.B \-i, \-\-ping\-int \fB\fItime\fB\fR
 Якщо зв'язок TCP/IP між парою пристроїв DRBD є вільним більш ніж time секунд, DRBD буде генерувати пакети keep\-alive, для перевірки справної роботи партнера. По замовчуванню 10 секунд, крок 1 секунда.

.TP
.B \-t, \-\-timeout \fB\fIval\fB\fR
 Якщо партнерський вузол не може відіслати пакет з відповіддю через time десятих секунди, партнерський вузол вважається не робочим і тому TCP/IP зв'язок до нього розривається. Це значення мусить бути меншим ніж connect\-int та ping\-int. По замовчуванню є 60 = 6 секунд, крок 0.1 секунди.

.TP
.B \-S, \-\-sndbuf\-size \fB\fIsize\fB\fR
 Розмір вихідної черги для зберігання TCP пакетів перед відправкою на другорядний вузол, на котрий з мережевих причин не може передати. Можна вказати більше чи менше значення. Більше значення краще для збільшення пропускної здатності при використанні протоколу А через  достатньо постійну мережу. Дуже великі значення ~1M можуть привести до проблем. Пам'ятайте чим більша асинхронність тим більше даних пропаде при втраті основного вузла. А значення менші 32K не доречні. По замовчуванню 128K. По замовчуванню крок K.

.TP
.B \-k, \-\-ko\-count \fB\fIcount\fB\fR
 У випадку зупинки другорядного вузла і неспосібності завершити один запис після count спроб з інтервалами timeout, він відключається від кластеру. (основний вузол переходить у вироджений стан) По замовчуванню 0, що відключає цю властивість.

.TP
.B \-e, \-\-max\-epoch\-size \fB\fIval\fB\fR
 З цією опцією максимальне число запитів запису між двома бар'єрами є обмежене. Краще встановити такою ж, як \fB\-\-max\-buffers\fR. Значення менші 100 істотно зменшують продуктивність. По замовчуванню 2048.

.TP
.B \-b, \-\-max\-buffers \fB\fIval\fB\fR
 Опція обмежує максимальне число сторінок черги для прийому запиті запису другорядним вузлом DRBD. Повинно бути встановлене такою ж, як \fB\-\-max\-epoch\-size\fR. Малі значення можуть зменшити продуктивність. (Мінімальне 32). по замовчуванню 2048.

.TP
.B \-d, \-\-on\-disconnect \fB\fIdiscon_handler\fB\fR
 Коли зв'язок з партнером розривається, DRBD може перейти в вироджений режим з одним вузлом, намагатись відновити зв'язок чи припинити ввід/вивід. Допустимі значення \fBstand_alone\fR, \fBreconnect\fR та \fBfreeze_io\fR. По замовчуванню відновити зв'язок \fBreconnect\fR.

.SS "SYNCER"

.PP

Змінює синхронізаційні параметри сервісу пристрою під час роботи. Не міняє mentioned параметрів.

.TP
.B \-r, \-\-rate \fB\fIrate\fB\fR
 Для гарантування належної роботи програм поверху DRBD, є можливим обмежити розмір каналу, що використовується для синхронізації. По замовчуванню 250KB/sec, крок по замовчуванню 1KB/sec.

.TP
.B \-k, \-\-skip\-sync
 Опція відключає автоматичний старт синхронізаційного процесу, що відбувається одразу після з'єднання DRBD пристроїв.

.TP
.B \-g, \-\-sync\-group \fB\fIgroup\fB\fR
 Синхронізація всіх пристроїв в одній групі проводиться паралельно. Доступ групами здійснюється послідовно. Вам потрібно запобігати, щоб низькорівневі пристрої розміщені на одному фізичному носії синхронізуватись паралельно. По замовчуванню всі належать до групи 0 і синхронізуватимуться паралельно.

.TP
.B \-e, \-\-al\-extents \fB\fIextents\fB\fR
 DRBD здійснює автоматично визначення робочої області. Цим параметром контролюється скільки місця виділяється для роботи (=active set). Кожна одиниця відповідає 4M робочого диску (=низькорівневого пристрою). У випадку неочікуваної зупинки основного вузла розмір даних визначений опцією мусить бути розсинхронізований до часу зупинки вузла. Структура даних зберігається в області службових даних, тому кожна зміна робочої області приводить до операції запису на пристрій з службовими даними. Велике число extents дає довший період десинхронізації але менші поновлення до службових даних. По замовчуванню extents є 127. Мінімум 7, максимум 3843.

.SS "PRIMARY"

.PP

Встановлення \fB\fIпристрою\fB\fR в основний стан, що означає можливість відкриття його програмами (чи файловими системами) для читання та запису. Дані, що пишуться на \fB\fIпристрій\fB\fR в основному стані дзеркально відображаються на \fB\fIпристрій\fB\fR в другорядному стані.

Не можливо встановити обидва пристрої з'єднаної DRBD пари в основний стан.

.TP
.B \-h, \-\-human
 Встановлює що стан змінений адміном і при перезавантажені кластеру має перевагу над рішеннями прийнятими іншими партнерами.

.TP
.B \-t, \-\-timeout\-expired
 Визначає, що стан змінився по причині того, що вузол був відсутній при старті кластеру (кластер запустивсь в виродженому стані). По відношенню до кластера це переважає рішення зроблене управлінням кластера.

.TP
.B \-d, \-\-do\-what\-I\-say
 Перехід в основний стан не відбувається коли є не завершена локальна реплікація. Використовуючи цю опцію вузол завжди переводиться в основний стан. ВИКОРИСТОВУЙТЕ ЇЇ ТІЛЬКИ КОЛИ ЗНАЄТЕ, ЩО РОБИТЕ.

.SS "SECONDARY"

.PP

Встановлює \fB\fIпристрій\fB\fR в другорядний стан. Ця команда не виконається коли хоча б одна програма (чи файлова система) має відкритий доступ на запис на цей пристрій.
.br

Однак можливо, що обидва пристрої з'єднані в DRBD пару є в другорядному стані.

.SS "ON_PRIMARY"

.PP

Це встановлює додаткову опцію, що приводить до наступного переходу в основний стан. Опція дійсна тільки поки пристрій не зв'яжеться з своїм партнером. Можливі опції: \fB\-\-inc\-human\fR та \fB\-\-inc\-timeout\-expired\fR.
.br

Ця команда є для зручності. Ефект від неї той же, як би вказати цю опцію до команди \fBprimary\fR напряму. Для детального опису двох опцій дивіться команду \fBprimary\fR.

.SS "NVALIDATE"

.PP

Насильно переводить локальний пристрій, пари пристроїв підключених до DRBD в стані їх партнерської синхронізації, що означає копіювання всіх блоків даних з партнера на локальний пристрій.
.br

Ця команда не виконається, коли \fB\fIпристрої\fB\fR не є частиною пари з'єднаних пристроїв.

.SS "INVALIDATE_REMOTE"

.PP

Насильно переводить локальний пристрій DRBD пристроїв в стан джерела їх синхронізації, що означає копіювання всіх блоків даних з локального пристрою до партнера.

.SS "WAIT_CONNECT"

.PP

Продовжує тоді коли \fB\fIпристрій\fB\fR може зв'язуватись з своїм партнерським пристроєм.

.TP
.B \-t, \-\-wfc\-timeout \fB\fIwfc_timeout\fB\fR

.TP
.B \-d, \-\-degr\-wfc\-timeout \fB\fIdegr_wfc_timeout\fB\fR

Команда видасть помилку, коли пристрій не зможе зв'язатись з своїм партнером на протязі \fB\fItimeout\fB\fR секунд. Якщо партнер працював перед перевантаженням вузла, використовується \fB\fIwfc_timeout\fB\fR. Якщо партнер відключивсь перед перевантаженням вузла, використовується \fB\fIdegr_wfc_time\-out\fB\fR. По замовчуванню значення \fB\fIwfc_timeout\fB\fR рівне 0, що значить чекати вічно. Значення по замовчуванню для \fB\fIdegr_wfc_timeout\fB\fR рівне 120 секунд.

.SS "WAIT_SYNC"

.PP

Продовжує тоді коли \fB\fIпристрій\fB\fR виходить з будь\-якого синхронізаційного стану, і повертається в стан зв'язку. Опції такі ж, як з командою \fB\fIwait_connect\fB\fR.

.SS "DISCONNECT"

.PP

Видаляє інформацію встановлену командою \fBNET\fR з \fB\fIпристрою\fB\fR. Тобто переводить \fB\fIпристрій\fB\fR в від'єднаний стан, що означає не прослуховування більше мережі.

.SS "DETACH"

.PP

Видаляє інформацію встановлену командою \fBDISK\fR з \fB\fIпристрою\fB\fR. Це приводить до від'єднання \fB\fIпристрою\fB\fR від низькорівневого пристрою.

.SS "DOWN"

.PP

Видаляє всю конфіґураційну інформацію з \fB\fIпристрою\fB\fR і переводить його назад в не налаштований стан.

.SS "STATE"

.PP

Показує поточний стан \fB\fIпристрою\fB\fR і його партнера (local/peer).

.SS "CSTATE"

.PP

Показує поточний стан зв'язку \fB\fIпристрою\fB\fR.

.SS "RESIZE"

.PP

Це приведе до перевірки розміру низькорівневих дисків. Щоб здійснити  збільшення диску робочої системи потрібно розширити низькорівневі диски на обох \fB\fIпристроях\fB\fR та викликати команду \fBresize\fR на обох вузлах.

.SS "SHOW"

.PP

Показує всю доступну конфіґураційну інформацію \fB\fIпристрою\fB\fR.

.SH "ПРИКЛАДИ"
.PP

.SS "ВСТАНОВЛЕННЯ ПАРИ ПРИСТРОЇВ"
.PP

В цьому прикладі комп'ютери, \fB\fItc1\fB\fR і \fB\fItc2\fB\fR, сполучені прямим кабелем через інтерфейс \fB\fI192.168.37.2\fB\fR  (tc1)  і \fB\fI192.168.37.3\fB\fR (tc2). Включимо /dev/hda6 у віртуальний диск.
.br

На tc1 виконуємо

.RS
.nf
            $ drbdsetup /dev/drbd0 disk /dev/hda6
            $ drbdsetup /dev/drbd0 net 192.168.37.2 192.168.37.3 B

.fi
.RE
На tc2 виконуємо:

.RS
.nf
            $ drbdsetup /dev/drbd0 disk /dev/hda6
            $ drbdsetup /dev/drbd0 net 192.168.37.3 192.168.37.2 B
            $ drbdsetup /dev/drbd0 primary
            $ cat /proc/drbd
            version: 0.7.0 (api:xx/proto:yy)
 
            0: cs:Connected st:Primary/Secondary ns:0 nr:0 dw:0 dr:0 of:0
            1: cs:WFConnection st:Secondary/Unknown ns:0 nr:0 dw:0 dr:0 of:0

.fi
.RE
Через /proc/drbd ми можемо бачити, що наша пара пристроїв є з'єднана та пристрій є готовий до використання на tc2.
.br

Тепер можна запускати програми поверху віртуального диску:

.RS
.nf
            $ mkfs \-b 4096 /dev/drbd0
            $ mount /dev/drbd0 /mnt/mountpoint

.fi
.RE

.SS "ЗНІМОК ДИСКУ ЗАПИСАТИ НА ТРЕТЮ МАШИНУ"
.PP

В цьому прикладі комп'ютер, \fB\fItc1\fB\fR і \fB\fItc2\fB\fR, є з'єднані і \fB\fItc2\fB\fR є основним вузлом пристрою /dev/drbd0 Знімок цього пристрою потрібно записати на \fB\fItc3\fB\fR, \fB\fI/dev/hda6\fB\fR.
.br

Нам потрібно підготувати tc3:

.RS
.nf
            $ drbdsetup /dev/drbd0 disk /dev/hda6
            $ drbdsetup /dev/drbd0 net tc3 tc2 B

.fi
.RE
На tc2 ми виконуємо

.RS
.nf
            $ drbdsetup /dev/drbd0 disconnect
            $ drbdsetup /dev/drbd0 net tc2 tc3 B \-\-sync\-rate 4M
            $ drbdsetup /dev/drbd0 replicate
            $ drbdsetup /dev/drbd0 wait_sync
            $ drbdsetup /dev/drbd0 disconnect
            $ drbdsetup /dev/drbd0 net tc2 tc1 B
            $ drbdsetup /dev/drbd0 replicate

.fi
.RE
Так як знімок диску береться без переведення диску в стабільний стан, потрібно виконати на tc3:

.RS
.nf
            $ drbdsetup /dev/drbd0 down
            $ fsck /dev/hda6
            $ mount /dev/hda6 /some/mountpoint

.fi
.RE

.SH "ВЕРСІЯ"
.PP

Цей документ коректний для версії 0.7.* пакету DRBD.

.SH "АВТОРИ"
.PP

Написаний Пилипом Рейзнером (Philipp  Reisner)  <philipp.reisner@linbit.com>.

.SH "ПОВІДОМЛЕННЯ ПОМИЛОК"
.PP

Повідомляйте про помилки на <drbd\-user@lists.linbit.com>.

.SH "АВТОРСЬКІ ПРАВА"
.PP

Copyright (c) 2001 Philipp Reisner. Це вільні програми; дивіться джерельні коди для встановлення прав копіювання. Нема ніяких гарантій; навіть для зручності використання в конкретному випадку.

.SH "ПОДІБНІ ТЕМИ"
.PP

\fBdrbd \- кластер дисків\fR, \fBdrbdadm(8)\fR, \fBdrbd.conf(5)\fR, \fBdrbd(8)\fR, \fBdatadisk(8)\fR

